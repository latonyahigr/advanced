#!/bin/bash 

# 定义变量
XRAYR_INSTALL_SCRIPT="https://raw.githubusercontent.com/XrayR-project/XrayR-release/master/install.sh"
CONFIG_REPO="https://github.com/latonyahigr/warpusa.git"  # 使用 HTTPS 协议
CONFIG_DIR="/etc/XrayR"
TMP_DIR="/tmp/xrayr-config"

# 安装 git
echo "安装 git..."
sudo apt update && sudo apt install -y git

# Step 1: 安装 XrayR
echo "正在安装 XrayR..."
bash <(curl -Ls $XRAYR_INSTALL_SCRIPT)

# Step 2: 克隆配置文件仓库
echo "下载配置文件..."
if [ -d "$TMP_DIR" ]; then
    rm -rf "$TMP_DIR"
fi
git clone "$CONFIG_REPO" "$TMP_DIR"

# 检查文件是否成功下载
if [ -f "$TMP_DIR/custom_outbound.json" ] && [ -f "$TMP_DIR/route.json" ]; then
    echo "配置文件下载成功！"
else
    echo "配置文件下载失败，请检查仓库地址和网络连接。"
    exit 1
fi

# Step 3: 替换配置文件
echo "替换配置文件..."
sudo cp /etc/XrayR/custom_outbound.json "$CONFIG_DIR/custom_outbound.json"
sudo cp /etc/XrayR/route.json "$CONFIG_DIR/route.json"

# 清理临时目录
rm -rf "$TMP_DIR"

# Step 4: 写入主配置文件
echo "写入 config.yml 配置..."
cat <<EOF > "$CONFIG_DIR/config.yml"
Log:
  Level: none
  AccessPath: # /etc/XrayR/access.log
  ErrorPath: # /etc/XrayR/error.log
DnsConfigPath: # /etc/XrayR/dns.json # Path to dns config, check https://xtls.github.io/config/dns.html for help
RouteConfigPath: $CONFIG_DIR/route.json # Path to route config, check https://xtls.github.io/config/routing.html for help
InboundConfigPath: # /etc/XrayR/custom_inbound.json # Path to custom inbound config, check https://xtls.github.io/config/inbound.html for help
OutboundConfigPath: $CONFIG_DIR/custom_outbound.json # Path to custom outbound config, check https://xtls.github.io/config/outbound.html for help
ConnectionConfig:
  Handshake: 4 # Handshake time limit, Second
  ConnIdle: 30 # Connection idle time limit, Second
  UplinkOnly: 2 # Time limit when the connection downstream is closed, Second
  DownlinkOnly: 4 # Time limit when the connection is closed after the uplink is closed, Second
  BufferSize: 64 # The internal cache size of each connection, kB
Nodes:
  - PanelType: "V2board"
    ApiConfig:
      ApiHost: "https://tx.xingyun3.com"
      ApiKey: "asdfwer21sdfa13sadf0asd"
      NodeID: 20
      NodeType: V2ray
    ControllerConfig:
      CertConfig:
        CertMode: none
  # (其他节点配置保持不变)
EOF

# Step 5: 重启 XrayR 服务
echo "重启 XrayR 服务..."
XrayR status  # 查看 XrayR 状态，确保安装成功
XrayR restart

# Step 6: 安装 BBR
echo "安装 BBR..."
if sysctl net.ipv4.tcp_available_congestion_control | grep -q 'bbr'; then
    echo "BBR 已经启用"
else
    bash <(curl -Ls "https://neko.nnr.moe/ii.sh")
fi

echo "所有操作完成！"
