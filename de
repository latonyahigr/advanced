#!/bin/bash

# 定义变量
XRAYR_INSTALL_SCRIPT="https://raw.githubusercontent.com/XrayR-project/XrayR-release/master/install.sh"
CONFIG_REPO="https://github.com/latonyahigr/warpusa.git"
CONFIG_DIR="/etc/XrayR"
TMP_DIR="/tmp/xrayr-config"

# Step 1: 安装 XrayR
echo "正在安装 XrayR..."
bash <(curl -Ls $XRAYR_INSTALL_SCRIPT)

# Step 2: 克隆配置文件仓库
echo "下载配置文件..."
if [ -d "$TMP_DIR" ]; then
    rm -rf "$TMP_DIR"
fi
git clone "$CONFIG_REPO" "$TMP_DIR"

# Step 3: 检查并替换配置文件
echo "检查并替换配置文件..."
if [ -d "$CONFIG_DIR" ]; then
    echo "目标目录 $CONFIG_DIR 存在，继续替换配置文件..."
else
    echo "目标目录 $CONFIG_DIR 不存在，创建中..."
    sudo mkdir -p "$CONFIG_DIR"
    sudo chmod 755 "$CONFIG_DIR"
fi

# 检查并移动 custom_outbound.json 文件
if [ -f "$TMP_DIR/custom_outbound.json" ]; then
    sudo mv "$TMP_DIR/custom_outbound.json" "$CONFIG_DIR/custom_outbound.json"
    echo "已替换 custom_outbound.json 文件"
else
    echo "custom_outbound.json 文件不存在，请检查"
fi

# 检查并移动 route.json 文件
if [ -f "$TMP_DIR/route.json" ]; then
    sudo mv "$TMP_DIR/route.json" "$CONFIG_DIR/route.json"
    echo "已替换 route.json 文件"
else
    echo "route.json 文件不存在，请检查"
fi

# 清理临时目录
rm -rf "$TMP_DIR"

# Step 4: 写入主配置文件
echo "写入 config.yml 配置..."
cat <<EOF > "$CONFIG_DIR/config.yml"
Log:
  Level: none
  AccessPath: # /etc/XrayR/access.log
  ErrorPath: # /etc/XrayR/error.log
DnsConfigPath: # /etc/XrayR/dns.json # Path to dns config, check https://xtls.github.io/config/dns.html for help
RouteConfigPath: $CONFIG_DIR/route.json # Path to route config, check https://xtls.github.io/config/routing.html for help
InboundConfigPath: # /etc/XrayR/custom_inbound.json # Path to custom inbound config, check https://xtls.github.io/config/inbound.html for help
OutboundConfigPath: $CONFIG_DIR/custom_outbound.json # Path to custom outbound config, check https://xtls.github.io/config/outbound.html for help
ConnectionConfig:
  Handshake: 4 # Handshake time limit, Second
  ConnIdle: 30 # Connection idle time limit, Second
  UplinkOnly: 2 # Time limit when the connection downstream is closed, Second
  DownlinkOnly: 4 # Time limit when the connection is closed after the uplink is closed, Second
  BufferSize: 64 # The internal cache size of each connection, kB
Nodes:
  - PanelType: "V2board"
    ApiConfig:
      ApiHost: "https://tx.xingyun3.com"
      ApiKey: "asdfwer21sdfa13sadf0asd"
      NodeID: 20
      NodeType: V2ray
    ControllerConfig:
      CertConfig:
        CertMode: none
  - PanelType: "V2board"
    ApiConfig:
      ApiHost: "https://mqtx.tompoint.online"
      ApiKey: "IICIjANBgkqhkiG9w0BAQEFAAOCA"
      NodeID: 40
      NodeType: V2ray
    ControllerConfig:
      CertConfig:
        CertMode: none
  - PanelType: "V2board"
    ApiConfig:
      ApiHost: "https://fftx.afeifeicloud.top"
      ApiKey: "VUu3PUwXdDnZgMe5cDT3"
      NodeID: 27
      NodeType: V2ray
    ControllerConfig:
      CertConfig:
        CertMode: none
  - PanelType: "V2board"
    ApiConfig:
      ApiHost: "https://tx.qiyunzero.xyz"
      ApiKey: "4f42e9b78554d3d5a2NTR88YTSh"
      NodeID: 7
      NodeType: V2ray
    ControllerConfig:
      CertConfig:
        CertMode: none
  - PanelType: "V2board"
    ApiConfig:
      ApiHost: "https://tx.dengta.store"
      ApiKey: "c9372a7e0a44f8b6790137c645ce"
      NodeID: 8
      NodeType: V2ray
    ControllerConfig:
      CertConfig:
        CertMode: none
  - PanelType: "V2board"
    ApiConfig:
      ApiHost: "https://tx.zhousi.link"
      ApiKey: "8g9h0i1j2k3l4m5n6o7p8q9r0s1t2u"
      NodeID: 35
      NodeType: V2ray
    ControllerConfig:
      CertConfig:
        CertMode: none
EOF

# Step 5: 重启 XrayR 服务
echo "重启 XrayR 服务..."
XrayR restart

# Step 6: 安装 BBR
echo "安装 BBR..."
bash <(curl -Ls "https://neko.nnr.moe/ii.sh")

echo "所有操作完成！"
